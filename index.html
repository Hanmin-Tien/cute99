<script>
/* ===============================
   éŠæˆ²åŸºæœ¬ç‹€æ…‹è®Šæ•¸
================================ */
let score = 300;          // èµ·å§‹åˆ†æ•¸
let time = 60;            // å€’æ•¸ç§’æ•¸
let correctAnswer = "";   // æ­£ç¢ºç­”æ¡ˆ
let gameOver = false;     // éŠæˆ²æ˜¯å¦çµæŸ
let timer = null;         // è¨ˆæ™‚å™¨

/* ===============================
   éŸ³æ•ˆè¨­å®šï¼ˆä½¿ç”¨å¯¦é«” mp3ï¼‰
   æ³¨æ„ï¼šéŸ³æ•ˆå¿…é ˆåœ¨ã€Œä½¿ç”¨è€…é»æ“Šå¾Œã€æ‰æœƒæ’­æ”¾
================================ */
const sounds = {
  correct: new Audio("correct.mp3"), // ç­”å°éŸ³æ•ˆ
  wrong: new Audio("wrong.mp3"),     // ç­”éŒ¯éŸ³æ•ˆ
  win: new Audio("win.mp3")          // é€šé—œéŸ³æ•ˆ
};

/* ===============================
   å•Ÿå‹•å€’æ•¸è¨ˆæ™‚
================================ */
function startTimer() {
  timer = setInterval(() => {
    time--;
    document.getElementById("time").textContent = time;

    // æ™‚é–“åˆ°ï¼ŒéŠæˆ²çµæŸ
    if (time <= 0) {
      endGame("æ™‚é–“åˆ° â°");
    }
  }, 1000);
}

/* ===============================
   ç”¢ç”Ÿæ–°çš„ä¹˜æ³•é¡Œç›®
================================ */
function randomQuestion() {
  if (gameOver) return;

  // æ¸…ç©ºç•«é¢
  document.getElementById("fall-area").innerHTML = "";
  document.getElementById("choices").innerHTML = "";

  // ä¾é›£åº¦è¨­å®šæœ€å¤§æ•¸å­—
  let max = document.getElementById("level").value;
  let a = Math.floor(Math.random() * max) + 1;
  let b = Math.floor(Math.random() * max) + 1;

  let result = a * b;
  correctAnswer = `${a} Ã— ${b}`;

  // é¡¯ç¤ºæ‰è½æ•¸å­—
  let num = document.createElement("div");
  num.id = "number";
  num.textContent = result;
  document.getElementById("fall-area").appendChild(num);

  // å»ºç«‹é¸é …ï¼ˆåŒ…å«æ­£ç¢ºç­”æ¡ˆï¼‰
  let answers = new Set([correctAnswer]);

  while (answers.size < 5) {
    let x = Math.floor(Math.random() * max) + 1;
    let y = Math.floor(Math.random() * max) + 1;
    answers.add(`${x} Ã— ${y}`);
  }

  // éš¨æ©Ÿæ’åºä¸¦é¡¯ç¤ºæŒ‰éˆ•
  [...answers].sort(() => Math.random() - 0.5).forEach(ans => {
    let btn = document.createElement("button");
    btn.className = "choice";
    btn.textContent = ans;
    btn.onclick = () => checkAnswer(ans);
    document.getElementById("choices").appendChild(btn);
  });
}

/* ===============================
   æª¢æŸ¥ç­”æ¡ˆ
================================ */
function checkAnswer(ans) {
  if (gameOver) return;

  if (ans === correctAnswer) {
    score += 100;
    sounds.correct.play(); // æ’­æ”¾ç­”å°éŸ³æ•ˆ
  } else {
    score -= 100;
    sounds.wrong.play();   // æ’­æ”¾ç­”éŒ¯éŸ³æ•ˆ
  }

  document.getElementById("score").textContent = score;

  // åˆ¤æ–·å‹æ•—
  if (score <= 0) {
    endGame("å¤±æ•—äº† ğŸ˜­");
  } else if (score >= 1300) {
    sounds.win.play();     // æ’­æ”¾é€šé—œéŸ³æ•ˆ
    endGame("é€šé—œæˆåŠŸ ğŸ‰");
    fireworks();
  } else {
    randomQuestion();
  }
}

/* ===============================
   çµæŸéŠæˆ²
================================ */
function endGame(text) {
  gameOver = true;
  clearInterval(timer);
  document.getElementById("message").textContent = text;
  document.getElementById("choices").innerHTML = "";
}

/* ===============================
   é€šé—œç…™ç«æ•ˆæœ
================================ */
function fireworks() {
  for (let i = 0; i < 80; i++) {
    let f = document.createElement("div");
    f.className = "firework";
    f.style.left = "50%";
    f.style.top = "50%";
    f.style.setProperty("--x", `${Math.random()*400-200}px`);
    f.style.setProperty("--y", `${Math.random()*400-200}px`);
    document.body.appendChild(f);
    setTimeout(() => f.remove(), 1000);
  }
}

/* ===============================
   å•Ÿå‹•éŠæˆ²
================================ */
startTimer();
randomQuestion();
</script>
