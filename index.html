<script>
/* ===============================
   éŠæˆ²ç‹€æ…‹è®Šæ•¸
================================ */
let score = 300;        // èµ·å§‹åˆ†æ•¸
let time = 60;          // å€’æ•¸æ™‚é–“
let correctAnswer = ""; // æ­£ç¢ºç­”æ¡ˆ
let gameOver = false;   // æ˜¯å¦çµæŸ
let timer = null;       // è¨ˆæ™‚å™¨

/* ===============================
   éŸ³æ•ˆè¨­å®š
================================ */
const sounds = {
  correct: new Audio("correct.mp3"),
  wrong: new Audio("wrong.mp3"),
  win: new Audio("win.mp3")
};

/* ===============================
   åˆå§‹åŒ–éŠæˆ²
================================ */
function initGame() {
  score = 300;
  time = 60;
  gameOver = false;

  document.getElementById("score").textContent = score;
  document.getElementById("time").textContent = time;
  document.getElementById("message").textContent = "";
  document.getElementById("choices").innerHTML = "";

  clearInterval(timer);
  startTimer();
  randomQuestion();
}

/* ===============================
   å€’æ•¸è¨ˆæ™‚
================================ */
function startTimer() {
  timer = setInterval(() => {
    if (gameOver) return;

    time--;
    document.getElementById("time").textContent = time;

    if (time <= 0) {
      endGame("æ™‚é–“åˆ° â°");
    }
  }, 1000);
}

/* ===============================
   å‡ºé¡Œï¼ˆæœƒä¾ç…§ç•¶å‰é›£åº¦ï¼‰
================================ */
function randomQuestion() {
  if (gameOver) return;

  const fallArea = document.getElementById("fall-area");
  const choices = document.getElementById("choices");

  fallArea.innerHTML = "";
  choices.innerHTML = "";

  // å³æ™‚è®€å–é›£åº¦
  const max = Number(document.getElementById("level").value);

  const a = Math.floor(Math.random() * max) + 1;
  const b = Math.floor(Math.random() * max) + 1;
  const result = a * b;

  correctAnswer = `${a} Ã— ${b}`;

  // é¡¯ç¤ºæ‰è½æ•¸å­—
  const num = document.createElement("div");
  num.id = "number";
  num.textContent = result;
  fallArea.appendChild(num);

  // å»ºç«‹é¸é …
  const answers = new Set([correctAnswer]);
  while (answers.size < 5) {
    const x = Math.floor(Math.random() * max) + 1;
    const y = Math.floor(Math.random() * max) + 1;
    answers.add(`${x} Ã— ${y}`);
  }

  [...answers].sort(() => Math.random() - 0.5).forEach(ans => {
    const btn = document.createElement("button");
    btn.className = "choice";
    btn.textContent = ans;
    btn.onclick = () => checkAnswer(ans);
    choices.appendChild(btn);
  });
}

/* ===============================
   æª¢æŸ¥ç­”æ¡ˆ
================================ */
function checkAnswer(ans) {
  if (gameOver) return;

  if (ans === correctAnswer) {
    score += 100;
    sounds.correct.play();
  } else {
    score -= 100;
    sounds.wrong.play();
  }

  document.getElementById("score").textContent = score;

  if (score <= 0) {
    endGame("å¤±æ•—äº† ğŸ˜­");
  } else if (score >= 1300) {
    sounds.win.play();
    girlCelebrate();     // å°å¥³å­©å‹•ä¸€ä¸‹
    endGame("é€šé—œæˆåŠŸ ğŸ‰");
  } else {
    randomQuestion();
  }
}

/* ===============================
   éŠæˆ²çµæŸ
================================ */
function endGame(text) {
  gameOver = true;
  clearInterval(timer);

  document.getElementById("choices").innerHTML = `
    <button class="choice" onclick="initGame()">ğŸ”„ é‡æ–°é–‹å§‹</button>
  `;
  document.getElementById("message").textContent = text;
}

/* ===============================
   å°å¥³å­©é€šé—œå‹•ç•«
================================ */
function girlCelebrate() {
  const girl = document.querySelector("#character img");
  girl.style.animation = "jump 0.8s ease";
  setTimeout(() => girl.style.animation = "", 800);
}

/* ===============================
   é›£åº¦åˆ‡æ›å³æ™‚ç”Ÿæ•ˆ
================================ */
document.getElementById("level").addEventListener("change", () => {
  if (!gameOver) {
    randomQuestion();
  }
});

/* ===============================
   å•Ÿå‹•éŠæˆ²
================================ */
initGame();
</script>
